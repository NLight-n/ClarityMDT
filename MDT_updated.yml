app:
  name: MDT Register Digital System
  stack:
    frontend: NextJS 14 (App Router, Server Actions)
    backend: NextJS API routes
    orm: Prisma ORM
    database: PostgreSQL
    object_storage: MinIO (S3-compatible)
    auth: NextAuth (Credentials Provider)
    styling: TailwindCSS / shadcn-ui
    pdf_generation: Server-side (PDFKit / Puppeteer)

  roles:
    - admin
    - coordinator
    - consultant
    - viewer

  role_management:
    description: |
      Admin can assign any user as a Coordinator.
      Multiple Coordinators are allowed.
      When Coordinator rights are revoked, the user returns to their previousRole
      (consultant or viewer). Coordinator role grants full coordinator permissions
      across the system.

  permissions:
    admin:
      - manage_users
      - manage_departments
      - manage_meetings
      - manage_all_cases
      - view_all_cases
      - edit_any_specialist_opinion
      - generate_reports
      - edit_radiology_findings
      - edit_pathology_findings
      - assign_or_revoke_coordinators

    coordinator:
      - manage_meetings
      - manage_all_cases
      - add_consensus_report
      - edit_consensus_report
      - edit_any_specialist_opinion
      - edit_radiology_findings
      - edit_pathology_findings
      - generate_reports

    consultant:
      - add_cases
      - edit_cases_in_own_department
      - view_cases_in_own_department
      - add_specialist_opinion
      - edit_own_specialist_opinion
      - edit_radiology_findings_if_radiology_department
      - edit_pathology_findings_if_pathology_department
      - resubmit_case

    viewer:
      - view_all_cases

  department_rules:
    radiology_editing:
      description: |
        Radiology department consultants may edit radiologyFindings,
        including rich text and inline images.

    pathology_editing:
      description: |
        Pathology department consultants may edit pathologyFindings,
        including rich text and inline images.

    specialists_opinion:
      description: |
        Consultants from other departments may add specialist opinions.
        Each opinion is editable only by:
          - author (consultant)
          - coordinator
          - admin

database:
  models:

    User:
      id: string (uuid)
      name: string
      loginId: string (unique)
      passwordHash: string
      role: enum(Admin, Coordinator, Consultant, Viewer)
      previousRole: enum(Consultant, Viewer) optional
      departmentId: string (nullable for admin/viewer)
      createdAt: datetime
      updatedAt: datetime

    Department:
      id: string (uuid)
      name: string
      createdAt: datetime
      updatedAt: datetime

    Meeting:
      id: string (uuid)
      date: date
      description: string optional
      createdBy: User
      createdAt: datetime
      updatedAt: datetime

    Case:
      id: string (uuid)
      patientName: string
      mrn: string optional
      age: int
      gender: enum(Male, Female, Other)
      presentingDepartmentId: string

      clinicalDetails: string

      radiologyFindings:
        type: richtext
        format: JSON
        description: |
          Contains rich text and inline images.
          Inline images are stored in MinIO and referenced by storageKey.

      pathologyFindings:
        type: richtext
        format: JSON
        description: |
          Contains rich text and inline images.
          Inline images are stored in MinIO and referenced by storageKey.

      diagnosisStage: string
      treatmentPlan: string
      question: string

      status: enum(DRAFT, SUBMITTED, PENDING, REVIEWED, RESUBMITTED, ARCHIVED)
      createdById: string
      assignedMeetingId: string optional
      submittedAt: datetime optional
      reviewedAt: datetime optional
      archivedAt: datetime optional
      createdAt: datetime
      updatedAt: datetime

    CaseAttachment:
      id: string (uuid)
      caseId: string
      fileName: string
      fileType: string
      fileSize: number
      storageKey: string
      createdAt: datetime

    SpecialistsOpinion:
      id: string (uuid)
      caseId: string
      consultantId: string
      departmentId: string
      opinionText: string
      createdAt: datetime
      updatedAt: datetime
      permissions:
        editableBy:
          - opinion_owner
          - coordinator
          - admin

    ConsensusReport:
      id: string (uuid)
      caseId: string
      finalDiagnosis: string
      mdtConsensus: string
      meetingDate: date
      remarks: string optional
      createdById: string
      createdAt: datetime
      updatedAt: datetime

ui:
  layout:
    sidebar:
      items:
        - Dashboard
        - Register
        - Cases
        - Meetings
        - Settings (admin & coordinator only)

  pages:
    Case Details:
      fields:
        - patientName
        - mrn
        - age
        - gender
        - presentingDepartment
        - clinicalDetails

        - radiologyFindings:
            type: richtext_with_inline_images
            editable_by:
              - radiology_consultants
              - coordinator
              - admin

        - pathologyFindings:
            type: richtext_with_inline_images
            editable_by:
              - pathology_consultants
              - coordinator
              - admin

        - diagnosisStage
        - treatmentPlan
        - question
        - specialistsOpinion (multiple entries)
        - attachments
        - history

workflows:
  radiology_pathology_inline_images:
    - user edits radiologyFindings/pathologyFindings rich-text
    - images added remain local (not uploaded yet)
    - on clicking Save:
        * upload new images to MinIO
        * delete removed images from MinIO
        * rewrite JSON structure with final storageKeys
        * save JSON into the case record
    - permissions:
        radiologyFindings:
          - radiology consultants
          - coordinator
          - admin
        pathologyFindings:
          - pathology consultants
          - coordinator
          - admin

storage:
  minio:
    buckets:
      - case-attachments
    file_paths:
      - cases/{caseId}/attachments/{filename}
      - cases/{caseId}/radiologyInline/{uuid}.png
      - cases/{caseId}/pathologyInline/{uuid}.png

api:
  coordinator_management:
    - PATCH /api/users/:id/assign-coordinator
      description: Assigns coordinator role to any user. Admin only.

    - PATCH /api/users/:id/revoke-coordinator
      description: Reverts user role to previousRole (consultant/viewer). Admin only.

  radiology-pathology-inline-images:
    - PATCH /api/cases/:id/radiology-findings
      description: Saves radiologyFindings rich JSON. Requires coordinator, admin,
                   or radiology consultant.

    - PATCH /api/cases/:id/pathology-findings
      description: Saves pathologyFindings rich JSON. Requires coordinator, admin,
                   or pathology consultant.

security:
  inline_image_permissions:
    radiology_findings:
      - radiology consultants
      - coordinator
      - admin
    pathology_findings:
      - pathology consultants
      - coordinator
      - admin

  image_upload:
    allowed_file_types: [png, jpg, jpeg]
    upload_only_on_save: true

pdfs:
  template:
    header: Hospital name + address

    description: |
      Consensus Report PDF will include only text content.
      Inline images inside radiologyFindings or pathologyFindings
      will NOT be rendered or downloaded.

    sections:
      - Patient Details
      - Diagnosis
      - Radiology Findings (text-only, images stripped)
      - Pathology Findings (text-only, images stripped)
      - Specialists' Opinions
      - Discussion Question
      - Consensus Report

    formatting_rules:
      radiologyFindings:
        strip_inline_images: true
        convert_richtext_to_plaintext: true

      pathologyFindings:
        strip_inline_images: true
        convert_richtext_to_plaintext: true

    footer:
      signature_block_bottom_right: "MDT Coordinator Signature"
